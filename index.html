<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Trading Bitget Futures - Strat√©gie Paires Positives</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/theme.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
</head>
<body>
    <div class="container my-4">
        <h1 class="text-center mb-4">üöÄ Bot Trading Bitget Futures</h1>
        
        <!-- Navigation simplifi√©e avec balance et connexion -->
        <div class="topbar">
            <div class="topbar-title">‚öôÔ∏è Configuration du Bot</div>

            <div class="topbar-actions">
                <!-- Balance -->
                <div class="chip chip-balance">
                    <span class="label">üí≥ Balance:</span>
                    <span class="value" id="usdtBalance">--</span>
                    <span class="unit">USDT</span>
                </div>

                <!-- Connexion API -->
                <div class="chip chip-connection">
                    <div class="status" style="margin-bottom:0;">
                        <div class="status-dot" id="connectionStatus"></div>
                        <span id="connectionText" class="connection-status-text">D√©connect√©</span>
                    </div>
                    <button class="btn btn-ghost" onclick="testConnection()">Connecter</button>
                </div>
            </div>
        </div>
        
        <div class="card">
                    
                    <!-- Contenu principal organis√© en sections -->
                    <div class="grid-2">
                        <!-- Section Strat√©gie -->
                        <div>
                            <h4 class="section-title section-success">üìä Strat√©gie de Trading</h4>
                            
                            <!-- Positions Actives - Design Sexy -->
                            <div class="panel panel-accent">
                                <!-- Header avec ic√¥ne anim√©e et PNL total -->
                                <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                    <!-- Gauche : Ic√¥ne + Titre -->
                                    <div style="display: flex; align-items: center;">
                                        <div style="background: rgba(255,255,255,0.06); border-radius: 50%; padding: 8px; margin-right: 10px;">
                                            <span style="font-size: 18px;">‚ö°</span>
                                        </div>
                                        <div>
                                            <h3 style="margin: 0; font-size: 16px; font-weight: bold;">Positions Actives</h3>
                                            <div style="font-size: 12px; color: var(--muted);">
                                                <span id="positionCount">0</span> position(s) active(s)
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Droite : PNL Total en Live -->
                                    <div style="text-align: right;">
                                        <div style="font-size: 11px; color: var(--muted); margin-bottom: 2px;">PNL Total</div>
                                        <div id="totalPnLDisplay" style="
                                            font-size: 16px;
                                            font-weight: bold;
                                            padding: 6px 12px;
                                            border-radius: 8px;
                                            background: rgba(107, 114, 128, 0.2);
                                            color: #9ca3af;
                                            min-width: 100px;
                                            text-align: center;
                                        ">
                                            $0.00
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Liste des positions -->
                                <div id="positionsList" class="panel-inner">
                                    <div style="text-align: center; color: var(--muted); font-style: italic; padding: 20px;">
                                        <span style="font-size: 14px;">üí§ Aucune position active</span><br>
                                        <span style="font-size: 11px; margin-top: 5px; display: block;">En attente d'opportunit√©s...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section Param√®tres -->
                        <div>
                            <h4 class="section-title section-info">‚öôÔ∏è Param√®tres de Trading</h4>
                            
                            <!-- Champs API cach√©s mais fonctionnels + param√®tres fixes -->
                            <div style="display: none;">
                                <input type="password" id="apiKey" value="bg_63a0c59f5cdb1dce7e405a400d81b081">
                                <input type="password" id="secretKey" value="96528623d3ece2284b6eef752c801ed09d03dc95551c7be459a3a2e8b5abd388">
                                <input type="password" id="passphrase" value="Charmant16320">
                                <!-- Param√®tres fixes pour la nouvelle strat√©gie -->
                                <input type="number" id="capitalPercent" value="50">
                                <input type="number" id="trailingStop" value="2">
                                <select id="leverage"><option value="5" selected>5x</option></select>
                            </div>
                            
                            <!-- Configuration Strat√©gie - Design am√©lior√© -->
                            <div class="config-section">
                                <div class="section-header">
                                    <h4>‚öôÔ∏è Configuration de Trading</h4>
                                </div>
                                
                                <div class="config-grid">
                                    <div class="config-item">
                                        <div class="config-label">üí∞ Capital par trade</div>
                                        <div class="number-input-container">
                                            <input type="number" 
                                                   id="capitalPercentInput" 
                                                   min="10" 
                                                   max="90" 
                                                   step="5" 
                                                   value="50" 
                                                   class="number-input"
                                                   oninput="updateCapitalPercent(this.value)">
                                            <div class="arrow-buttons">
                                                <button class="arrow-btn" onclick="incrementCapitalPercent()">‚ñ≤</button>
                                                <button class="arrow-btn" onclick="decrementCapitalPercent()">‚ñº</button>
                                            </div>
                                            <span class="pnl-unit">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="config-item">
                                        <div class="config-label">üìà Levier</div>
                                        <div class="number-input-container">
                                            <input type="number" 
                                                   id="leverageInput" 
                                                   min="2" 
                                                   max="10" 
                                                   step="1" 
                                                   value="10" 
                                                   class="number-input"
                                                   oninput="updateLeverage(this.value)">
                                            <div class="arrow-buttons">
                                                <button class="arrow-btn" onclick="incrementLeverage()">‚ñ≤</button>
                                                <button class="arrow-btn" onclick="decrementLeverage()">‚ñº</button>
                                            </div>
                                            <span class="leverage-unit">x</span>
                                        </div>
                                    </div>
                                    
                                    <div class="config-item">
                                        <div class="config-label">üéØ Objectif PnL</div>
                                        <div class="number-input-container">
                                            <input type="number" 
                                                   id="targetPnLInput" 
                                                   min="0.2" 
                                                   max="3.0" 
                                                   step="0.05" 
                                                   value="0.90" 
                                                   class="number-input"
                                                   oninput="updateTargetPnL(this.value)">
                                            <div class="arrow-buttons">
                                                <button class="arrow-btn" onclick="incrementTargetPnL()">‚ñ≤</button>
                                                <button class="arrow-btn" onclick="decrementTargetPnL()">‚ñº</button>
                                            </div>
                                            <span class="pnl-unit">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="config-item">
                                        <div class="config-label">üîÑ Nombre de positions simultan√©es</div>
                                        <div class="number-input-container">
                                            <input type="number" 
                                                   id="botLimitInput" 
                                                   min="2" 
                                                   max="25" 
                                                   step="1" 
                                                   value="8" 
                                                   class="number-input"
                                                   oninput="updateBotLimit(this.value)">
                                            <div class="arrow-buttons">
                                                <button class="arrow-btn" onclick="incrementBotLimit()">‚ñ≤</button>
                                                <button class="arrow-btn" onclick="decrementBotLimit()">‚ñº</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="config-item">
                                        <div class="config-label">‚è±Ô∏è Temps max position (heures)</div>
                                        <div class="number-input-container">
                                            <input type="number" 
                                                   id="maxTimeInput" 
                                                   min="3" 
                                                   max="48" 
                                                   step="1" 
                                                   value="4" 
                                                   class="number-input"
                                                   oninput="updateMaxTime(this.value)">
                                            <div class="arrow-buttons">
                                                <button class="arrow-btn" onclick="incrementMaxTime()">‚ñ≤</button>
                                                <button class="arrow-btn" onclick="decrementMaxTime()">‚ñº</button>
                                            </div>
                                            <span class="pnl-unit">h</span>
                                        </div>
                                    </div>
                                    
                                    <div class="config-item">
                                        <div class="config-label">‚ùÑÔ∏è Cooldown TP (heures)</div>
                                        <div class="number-input-container">
                                            <input type="number" 
                                                   id="cooldownHoursInput" 
                                                   min="1" 
                                                   max="24" 
                                                   step="1" 
                                                   value="6" 
                                                   class="number-input"
                                                   oninput="updateCooldownHours(this.value)">
                                            <div class="arrow-buttons">
                                                <button class="arrow-btn" onclick="incrementCooldownHours()">‚ñ≤</button>
                                                <button class="arrow-btn" onclick="decrementCooldownHours()">‚ñº</button>
                                            </div>
                                            <span class="pnl-unit">h</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Statut Bot - Design am√©lior√© -->
                            <div class="status-section">
                                <div class="section-header">
                                    <h4>üìä √âtat du Bot</h4>
                                </div>
                                
                                <div class="status-main">
                                    <div class="status-indicator">
                                        <div class="status-dot" id="botStatusDot"></div>
                                        <span id="currentScanPair" class="status-text">En attente de d√©marrage...</span>
                                    </div>
                                </div>
                                
                                <!-- üÜï Statistiques d√©taill√©es du scan -->
                                <div class="scan-statistics">
                                    <div class="stat-row">
                                        <span class="stat-label">üìà Paires valides :</span>
                                        <span class="stat-value" id="validPairsCount">--</span>
                                    </div>
                                    <div class="stat-row">
                                        <span class="stat-label">  ‚Ä¢ (5-15%) total:</span>
                                        <span class="stat-value" id="validPairsTotal">--</span>
                                    </div>
                                    <div class="stat-row">
                                        <span class="stat-label">  ‚Ä¢ (5-15%) cooldown ‚ùÑÔ∏è:</span>
                                        <span class="stat-value" id="validPairsCooldown">--</span>
                                    </div>
                                    <div class="stat-row">
                                        <span class="stat-label">  ‚Ä¢ (5-15%) disponibles:</span>
                                        <span class="stat-value" id="validPairsAvailable">--</span>
                                    </div>
                                    <div class="stat-row">
                                        <span class="stat-label">‚è±Ô∏è Derni√®re analyse:</span>
                                        <span class="stat-value" id="lastAnalysisTime">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- üÜï Tuile des paires en cooldown avec compte √† rebours -->
                            <div class="cooldown-section">
                                <div class="section-header">
                                    <h4 id="cooldownTitle">‚è∞ Paires en Cooldown (6h)</h4>
                                </div>
                                <div class="cooldown-list" id="cooldownList">
                                    <div style="text-align: center; color: #ccc; padding: 20px;">
                                        Aucune paire en cooldown
                                    </div>
                                </div>
                            </div>

                            <!-- Statistiques Performance - Design am√©lior√© -->
                            <div class="stats-section">
                                <div class="section-header">
                                    <h4>üìà Performance</h4>
                                </div>
                                
                                <div class="performance-grid">
                                    <div class="perf-item success">
                                        <div class="perf-icon">‚úÖ</div>
                                        <div class="perf-info">
                                            <div class="perf-label">Gagnantes</div>
                                            <div class="perf-value" id="winningPositions">0 (+0$)</div>
                                        </div>
                                    </div>
                                    
                                    <div class="perf-item danger">
                                        <div class="perf-icon">‚ùå</div>
                                        <div class="perf-info">
                                            <div class="perf-label">Perdantes</div>
                                            <div class="perf-value" id="losingPositions">0 (-0$)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Contr√¥les en bas -->
                    <div class="section-footer">
                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                            <button class="btn btn-wide" onclick="startBot()" id="startBtn">‚ñ∂Ô∏è D√©marrer le Bot</button>
                            <button class="btn btn-danger btn-wide" onclick="stopBot()" id="stopBtn" disabled>‚èπÔ∏è Arr√™ter le Bot</button>
                            <button class="btn btn-wide" onclick="downloadPositionLogs()" style="background: linear-gradient(45deg, #8b5cf6, #7c3aed);">üì• T√©l√©charger Logs</button>
                        </div>
                    </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="js/utils.js"></script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/api-queue.js"></script>
    <script src="js/monitoring.js"></script>
    <script src="js/position-logger.js"></script>
    <script src="js/trading.js"></script>
    <script src="js/main.js"></script>
    
    <script>
        // üéØ NOUVELLE FONCTION: Mettre √† jour l'objectif PnL
        function updateTargetPnL(value) {
            let targetPnL = parseFloat(value);
            
            // Validation des limites
            if (targetPnL < 0.2) targetPnL = 0.2;
            if (targetPnL > 3.0) targetPnL = 3.0;
            
            // Arrondir √† 0.05%
            targetPnL = Math.round(targetPnL / 0.05) * 0.05;
            
            // Mettre √† jour la configuration
            config.targetPnL = targetPnL;
            
            // Mettre √† jour l'input
            document.getElementById('targetPnLInput').value = targetPnL.toFixed(2);
            
            // Log de confirmation
            if (typeof log === 'function') {
                log(`üéØ Objectif PnL modifi√©: +${targetPnL.toFixed(2)}%`, 'SUCCESS');
            }
            
            // Mettre √† jour les positions existantes si le bot tourne
            if (typeof botRunning !== 'undefined' && botRunning && typeof openPositions !== 'undefined' && openPositions && openPositions.length > 0) {
                openPositions.forEach(position => {
                    position.targetPnL = targetPnL;
                });
                if (typeof log === 'function') {
                    log(`üìä ${openPositions.length} position(s) existante(s) mise(s) √† jour avec nouvel objectif +${targetPnL.toFixed(2)}%`, 'INFO');
                }
            }
        }
        
        // üéØ Incr√©menter/D√©cr√©menter le PnL
        function incrementTargetPnL() {
            const input = document.getElementById('targetPnLInput');
            let value = parseFloat(input.value) + 0.05;
            if (value > 3.0) value = 3.0;
            updateTargetPnL(value);
        }
        
        function decrementTargetPnL() {
            const input = document.getElementById('targetPnLInput');
            let value = parseFloat(input.value) - 0.05;
            if (value < 0.2) value = 0.2;
            updateTargetPnL(value);
        }
        
        // üéØ NOUVELLE FONCTION: Mettre √† jour la limite de positions bot
        function updateBotLimit(value) {
            let botLimit = parseInt(value);
            
            // Validation des limites
            if (botLimit < 2) botLimit = 2;
            if (botLimit > 25) botLimit = 25;
            
            // Mettre √† jour la configuration
            config.maxBotPositions = botLimit;
            
            // Mettre √† jour l'input
            document.getElementById('botLimitInput').value = botLimit;
            
            // Mettre √† jour l'affichage du statut
            const botPositionsCount = document.getElementById('botPositionsCount');
            if (botPositionsCount) {
                const currentCount = typeof openPositions !== 'undefined' ? openPositions.filter(pos => pos.isBotManaged === true).length : 0;
                botPositionsCount.textContent = `${currentCount}/${botLimit}`;
            }
            
            // Log de confirmation
            if (typeof log === 'function') {
                log(`üîÑ Limite bot modifi√©e: ${botLimit} positions max`, 'SUCCESS');
            }
        }
        
        // üéØ Incr√©menter/D√©cr√©menter la limite bot
        function incrementBotLimit() {
            const input = document.getElementById('botLimitInput');
            let value = parseInt(input.value) + 1;
            if (value > 25) value = 25;
            updateBotLimit(value);
        }
        
        function decrementBotLimit() {
            const input = document.getElementById('botLimitInput');
            let value = parseInt(input.value) - 1;
            if (value < 2) value = 2;
            updateBotLimit(value);
        }
        
        // üéØ NOUVELLE FONCTION: Mettre √† jour le capital %
        function updateCapitalPercent(value) {
            let capitalPercent = parseInt(value);
            
            // Validation des limites
            if (capitalPercent < 10) capitalPercent = 10;
            if (capitalPercent > 90) capitalPercent = 90;
            
            // Arrondir √† 5%
            capitalPercent = Math.round(capitalPercent / 5) * 5;
            
            // Mettre √† jour la configuration
            config.capitalPercent = capitalPercent;
            
            // Mettre √† jour l'input
            document.getElementById('capitalPercentInput').value = capitalPercent;
            
            // Log de confirmation
            if (typeof log === 'function') {
                log(`üí∞ Capital par trade modifi√©: ${capitalPercent}%`, 'SUCCESS');
            }
        }
        
        // üéØ Incr√©menter/D√©cr√©menter le capital %
        function incrementCapitalPercent() {
            const input = document.getElementById('capitalPercentInput');
            let value = parseInt(input.value) + 5;
            if (value > 90) value = 90;
            updateCapitalPercent(value);
        }
        
        function decrementCapitalPercent() {
            const input = document.getElementById('capitalPercentInput');
            let value = parseInt(input.value) - 5;
            if (value < 10) value = 10;
            updateCapitalPercent(value);
        }
        
        // üéØ NOUVELLE FONCTION: Mettre √† jour le levier
        function updateLeverage(value) {
            let leverage = parseInt(value);
            
            // Validation des limites
            if (leverage < 2) leverage = 2;
            if (leverage > 10) leverage = 10; // Changed from 5 to 10
            
            // Mettre √† jour la configuration
            config.leverage = leverage;
            
            // Mettre √† jour l'input
            document.getElementById('leverageInput').value = leverage;
            
            // Log de confirmation
            if (typeof log === 'function') {
                log(`üìà Levier modifi√©: x${leverage}`, 'SUCCESS');
            }
        }
        
        // üéØ Incr√©menter/D√©cr√©menter le levier
        function incrementLeverage() {
            const input = document.getElementById('leverageInput');
            let value = parseInt(input.value) + 1;
            if (value > 10) value = 10; // Changed from 5 to 10
            updateLeverage(value);
        }
        
        function decrementLeverage() {
            const input = document.getElementById('leverageInput');
            let value = parseInt(input.value) - 1;
            if (value < 2) value = 2;
            updateLeverage(value);
        }
        
        // üéØ NOUVELLE FONCTION: Mettre √† jour le temps maximum des positions
        function updateMaxTime(value) {
            let maxTime = parseInt(value);
            
            // Validation des limites
            if (maxTime < 3) maxTime = 3;
            if (maxTime > 48) maxTime = 48;
            
            // Mettre √† jour la configuration
            config.maxPositionTimeHours = maxTime;
            
            // Mettre √† jour l'input
            document.getElementById('maxTimeInput').value = maxTime;
            
            // Log de confirmation
            if (typeof log === 'function') {
                log(`‚è±Ô∏è Temps maximum position modifi√©: ${maxTime}h`, 'SUCCESS');
            }
        }
        
        // üéØ Incr√©menter/D√©cr√©menter le temps max
        function incrementMaxTime() {
            const input = document.getElementById('maxTimeInput');
            let value = parseInt(input.value) + 1;
            if (value > 48) value = 48;
            updateMaxTime(value);
        }
        
        function decrementMaxTime() {
            const input = document.getElementById('maxTimeInput');
            let value = parseInt(input.value) - 1;
            if (value < 3) value = 3;
            updateMaxTime(value);
        }
        
        // üéØ NOUVELLE FONCTION: Mettre √† jour le temps de cooldown TP
        function updateCooldownHours(value) {
            let cooldownHours = parseInt(value);
            
            // Validation des limites
            if (cooldownHours < 1) cooldownHours = 1;
            if (cooldownHours > 24) cooldownHours = 24;
            
            // üÜï IMPORTANTE: Recalculer les cooldowns existants bas√© sur la nouvelle dur√©e
            const oldCooldownHours = config.takeProfitCooldownHours || 6;
            if (cooldownHours !== oldCooldownHours && typeof tradedPairsCooldown !== 'undefined') {
                const now = Date.now();
                const scaleFactor = cooldownHours / oldCooldownHours;
                
                // Parcourir tous les cooldowns existants
                Array.from(tradedPairsCooldown.entries()).forEach(([symbol, endTime]) => {
                    if (endTime > now) {
                        // Calculer le temps restant avec l'ancienne dur√©e
                        const remainingMs = endTime - now;
                        
                        // Appliquer le facteur d'√©chelle
                        const newRemainingMs = remainingMs * scaleFactor;
                        
                        // Calculer la nouvelle fin
                        const newEndTime = now + newRemainingMs;
                        
                        // Mettre √† jour
                        tradedPairsCooldown.set(symbol, newEndTime);
                    }
                });
                
                if (typeof log === 'function') {
                    log(`üîÑ Cooldowns existants recalcul√©s (${oldCooldownHours}h ‚Üí ${cooldownHours}h)`, 'INFO');
                }
            }
            
            // Mettre √† jour la configuration
            config.takeProfitCooldownHours = cooldownHours;
            
            // Mettre √† jour l'input
            document.getElementById('cooldownHoursInput').value = cooldownHours;
            
            // Mettre √† jour le titre et l'affichage de la tuile cooldown
            const cooldownTitle = document.getElementById('cooldownTitle');
            if (cooldownTitle) {
                cooldownTitle.textContent = `‚è∞ Paires en Cooldown (${cooldownHours}h)`;
            }
            
            // Rafra√Æchir l'affichage des cooldowns imm√©diatement
            if (typeof updateBotStatusDisplay === 'function') {
                updateBotStatusDisplay();
            }
            
            // Log de confirmation
            if (typeof log === 'function') {
                log(`‚ùÑÔ∏è Cooldown TP modifi√©: ${cooldownHours}h`, 'SUCCESS');
            }
        }
        
        // üéØ Incr√©menter/D√©cr√©menter le temps de cooldown TP
        function incrementCooldownHours() {
            const input = document.getElementById('cooldownHoursInput');
            let value = parseInt(input.value) + 1;
            if (value > 24) value = 24;
            updateCooldownHours(value);
        }
        
        function decrementCooldownHours() {
            const input = document.getElementById('cooldownHoursInput');
            let value = parseInt(input.value) - 1;
            if (value < 1) value = 1;
            updateCooldownHours(value);
        }
        
        // üîÑ Initialiser l'affichage au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser les valeurs
            const initialPnL = document.getElementById('targetPnLInput').value;
            updateTargetPnL(initialPnL);
            
            const initialBotLimit = document.getElementById('botLimitInput').value;
            updateBotLimit(initialBotLimit);
            
            const initialCapital = document.getElementById('capitalPercentInput').value;
            updateCapitalPercent(initialCapital);
            
            const initialLeverage = document.getElementById('leverageInput').value;
            updateLeverage(initialLeverage);
            
            const initialMaxTime = document.getElementById('maxTimeInput').value;
            updateMaxTime(initialMaxTime);

            const initialCooldownHours = document.getElementById('cooldownHoursInput').value;
            updateCooldownHours(initialCooldownHours);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html> 
