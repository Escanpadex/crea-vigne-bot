<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Trading Bitget Futures - Strat√©gie MACD TOP 20</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .status-dot.online {
            background: #28a745;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #1e7e34);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .logs {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 6px;
        }
        
        .price-display {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 10px 0;
        }
        
        .indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .indicator.buy {
            background: #28a745;
            color: white;
        }
        
        .indicator.sell {
            background: #dc3545;
            color: white;
        }
        
        .indicator.hold {
            background: #ffc107;
            color: #212529;
        }
        
        .version {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .top20-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
        }
        
        .pair-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            font-size: 12px;
            border-bottom: 1px solid #ddd;
        }
        
        .pair-item:last-child {
            border-bottom: none;
        }
        
        .scanning {
            background: #ffc107;
            color: black;
        }
        
        .position-item {
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="version">üìÖ 29/05/2025 - 15:30 - ADD LEVERAGE</div>
    
    <div class="container">
        <div class="header">
            <h1>üöÄ Bot Trading Bitget Futures</h1>
            <p>Strat√©gie MACD - TOP 20 Volume - Margin Mode ISOLATED Forc√©</p>
        </div>
        
        <div class="grid">
            <div class="card">
                <h3>‚öôÔ∏è Configuration API</h3>
                <div class="status">
                    <div class="status-dot" id="connectionStatus"></div>
                    <span id="connectionText">D√©connect√©</span>
                </div>
                
                <div class="form-group">
                    <label>API Key:</label>
                    <input type="password" id="apiKey" placeholder="Votre API Key Bitget">
                </div>
                
                <div class="form-group">
                    <label>Secret Key:</label>
                    <input type="password" id="secretKey" placeholder="Votre Secret Key">
                </div>
                
                <div class="form-group">
                    <label>Passphrase:</label>
                    <input type="password" id="passphrase" placeholder="Votre Passphrase">
                </div>
                
                <button class="btn" onclick="testConnection()">üîó Tester la connexion</button>
                <button class="btn btn-success" onclick="saveKeys()" style="margin-top: 10px;">üíæ Sauvegarder les cl√©s</button>
            </div>
            
            <div class="card">
                <h3>üìä Param√®tres Strat√©gie MACD</h3>
                
                <div class="form-group">
                    <label>Capital √† utiliser (% du total):</label>
                    <input type="number" id="capitalPercent" value="5" min="1" max="20" step="1">
                </div>
                
                <div class="form-group">
                    <label>Levier:</label>
                    <select id="leverage">
                        <option value="2" selected>2x</option>
                        <option value="3">3x</option>
                        <option value="5">5x</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Trailing Stop (%):</label>
                    <input type="number" id="trailingStop" value="1" min="0.5" max="5" step="0.1">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="startBot()" id="startBtn">‚ñ∂Ô∏è D√©marrer Strat√©gie</button>
                    <button class="btn btn-danger" onclick="stopBot()" id="stopBtn" disabled>‚èπÔ∏è Arr√™ter Bot</button>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="scanTop20Volume()" style="width: 100%;">üîç Scanner TOP 20 Volume</button>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h3>üìà TOP 20 Volume</h3>
                <div style="margin-bottom: 10px;">
                    <strong>Paire en cours:</strong> <span id="currentScanPair">--</span>
                </div>
                <div class="top20-list" id="top20List">
                    <div class="pair-item"><span>Chargement...</span><span>--</span></div>
                </div>
            </div>
            
            <div class="card">
                <h3>üíº Positions Ouvertes</h3>
                <div id="positionsContainer">
                    <div style="text-align: center; color: #666; padding: 20px;">Aucune position ouverte</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>üìù Logs de Trading</h3>
            <div class="logs" id="logs">
                [INFO] Bot MACD TOP 20 avec margin mode ISOLATED forc√©<br>
                [INFO] En attente de configuration API...<br>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api.crea-vigne.fr/api';
        let botRunning = false;
        let top20Pairs = [];
        let openPositions = [];
        let config = { apiKey: '', secretKey: '', passphrase: '', capitalPercent: 5, leverage: 2, trailingStop: 1.0 };
        let balance = { USDT: 0, totalEquity: 0 };
        
        function log(message, type = 'INFO') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] [${type}] ${message}<br>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        function saveKeys() {
            config.apiKey = document.getElementById('apiKey').value;
            config.secretKey = document.getElementById('secretKey').value;
            config.passphrase = document.getElementById('passphrase').value;
            log('üîë Cl√©s sauvegard√©es', 'SUCCESS');
        }
        
        async function makeRequest(endpoint, options = {}) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'apikey': config.apiKey,
                    'secretkey': config.secretKey,
                    'passphrase': config.passphrase,
                    'timestamp': Date.now().toString(),
                    ...options.headers
                };
                
                const response = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
                return await response.json();
            } catch (error) {
                log(`Erreur API: ${error.message}`, 'ERROR');
                return null;
            }
        }
        
        async function testConnection() {
            saveKeys();
            log('üîÑ Test de connexion...');
            
            const result = await makeRequest('/bitget/api/v2/mix/account/accounts?productType=USDT-FUTURES');
            
            if (result && result.code === '00000') {
                document.getElementById('connectionStatus').classList.add('online');
                document.getElementById('connectionText').textContent = 'Connect√©';
                log('‚úÖ Connexion r√©ussie!', 'SUCCESS');
                return true;
            } else {
                log('‚ùå √âchec de la connexion', 'ERROR');
                return false;
            }
        }
        
        async function scanTop20Volume() {
            log('üîç Scan TOP 20...');
            const response = await fetch(`${API_BASE}/bitget/api/v2/mix/market/tickers?productType=usdt-futures`);
            const data = await response.json();
            
            if (data.code === '00000' && data.data) {
                top20Pairs = data.data
                    .filter(pair => parseFloat(pair.usdtVolume || 0) > 10000000)
                    .sort((a, b) => parseFloat(b.usdtVolume) - parseFloat(a.usdtVolume))
                    .slice(0, 20);
                
                updateTop20Display();
                log(`‚úÖ TOP 20 mis √† jour: ${top20Pairs.length} paires`, 'SUCCESS');
            }
        }
        
        function updateTop20Display() {
            const container = document.getElementById('top20List');
            container.innerHTML = '';
            top20Pairs.forEach((pair, index) => {
                const item = document.createElement('div');
                item.className = 'pair-item';
                item.innerHTML = `<span>#${index + 1} ${pair.symbol}</span><span>${formatNumber(pair.usdtVolume)}</span>`;
                container.appendChild(item);
            });
        }
        
        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            return num.toFixed(2);
        }
        
        async function testOrder(symbol) {
            log(`üß™ TEST avec LEVERAGE + CROSS: ${symbol}`, 'INFO');
            
            const orderData = {
                symbol: symbol,
                productType: "USDT-FUTURES",
                marginMode: "cross",
                marginCoin: "USDT",
                leverage: "2", // üîß LEVIER 2x AJOUT√â
                size: "10",
                side: "buy",
                tradeSide: "open", 
                orderType: "market",
                clientOid: `test_${Date.now()}`
            };
            
            log(`üîß Donn√©es: ${JSON.stringify(orderData)}`, 'INFO');
            
            const result = await makeRequest('/bitget/api/v2/mix/order/place-order', {
                method: 'POST',
                body: JSON.stringify(orderData)
            });
            
            log(`üîß R√©ponse: ${JSON.stringify(result)}`, 'INFO');
            
            if (result && result.code === '00000') {
                log(`‚úÖ ORDRE R√âUSSI! ID: ${result.data.orderId}`, 'SUCCESS');
                log(`üéâ SOLUTION: marginMode=cross + leverage=2`, 'SUCCESS');
            } else {
                log(`‚ùå √âchec: ${result?.msg || 'Erreur'}`, 'ERROR');
            }
        }
        
        function startBot() {
            log('üöÄ D√©marrage du bot avec margin mode ISOLATED forc√©', 'SUCCESS');
            
            // Test imm√©diat avec la premi√®re paire
            if (top20Pairs.length > 0) {
                testOrder(top20Pairs[0].symbol);
            } else {
                log('‚ö†Ô∏è Scannez d\'abord le TOP 20', 'WARNING');
            }
        }
        
        function stopBot() {
            log('üõë Bot arr√™t√©', 'INFO');
        }
        
        window.onload = function() {
            log('‚úÖ Bot initialis√© - Version ISOLATED FORC√â', 'SUCCESS');
        };
    </script>
</body>
</html>
